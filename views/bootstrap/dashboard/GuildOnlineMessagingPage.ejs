<html>
  <%- include("../../EJScomp/bootstrap/nav", {user: user}); %>
  <div class="subheading">
    <div class="guildIcon&Info">
      <div
        class="guildIcon"
        style="background-image: url('https://cdn.discordapp.com/icons/<%- guild.id %>/<%- guild.icon %>.jpg');"
      ></div>
      <span> <%- guild.name %></span>
    </div>
    <div class="subHeadCategories">
      <ul class="menu">
        <li id="config" onclick="redirect(this.id)">Configuration</li>
        <li id="broadcast" onclick="redirect(this.id)">Broadcast Messages</li>
        <li id="commands" onclick="redirect(this.id)">Commands</li>
        <li id="memberlist" onclick="redirect(this.id)">Members List</li>
      </ul>
    </div>
  </div>
  <div class="container">
    <div class="header">
      <h1 style="text-align: center;">Broadcast</h1>
      <p>
        You can broadcast messages from a webbrowser! It also supports
        <b>markdown!</b>
      </p>
    </div>
    <div class="irc">
      <h2>Chat</h2>
      <div class="chatArea"><ul id="messages"></ul></div>
      <form action="">
        <div onload="fetchChannels()"><select id="channels"> </select></div>
        <input id="m" type="text" autocomplete="off" maxlength="18000" /><button
          class="btn btn-primary"
        >
          Send
        </button>
      </form>
    </div>
  </div>
</html>
<script>
  var socket = io.connect("http://localhost:80");
  socket.emit("fetchChannels", {
    guild: `<%- guild.id %>`
  });

  socket.on("channelsResp", d => {
    console.log(d);
    d.channels.forEach(c => {
      var doc = document.getElementById("channels");
      var node = document.createElement("option");
      node.id = c.id;
      node.value = c.id;
      var textnode = document.createTextNode(`#${c.name}`);
      node.appendChild(textnode);
      doc.appendChild(node);
      console.log(c.name);
    });
  });
  $(function() {
    $("form").submit(function() {
      $("#messages").append(
        $("<li>").text(`BOT [#${$("#channels").val()}]: ${$("#m").val()}`)
      );
      socket.emit("broadcast", {
        msg: $("#m").val(),
        channel: $("#channels").val(),
        guild: `<%- guild.id %>`
      });
      $("#m").val("");
      return false;
    });
    socket.on("chat message", function(msg) {
      console.log("sent 3 times from server");
      $("#messages").append($("<li>").text(`${msg.author}: ${msg.msg}`));
      window.scrollTo(0, document.body.scrollHeight);
    });
  });
  $("input[type=text]").change(function() {
    if ($("#m").val() == "") {
      $("button").attr("disabled", true);
    } else {
      $("button").attr("disabled", false);
    }
  });
  function redirect(id) {
    window.location.href = `/dashboard/edit/<%- user.id %>/<%- guild.id %>/manage/${id}`;
  }
</script>
<style>
  @import url("https://fonts.googleapis.com/css?family=Open+Sans");

  * {
    font-family: Open Sans;
  }

  .subheading {
    background: #2b2f33;
  }

  .guildIcon {
    width: 35px;
    height: 35px;
    background-size: 35px;
    background-position: center;
    border-radius: 50%;
    margin-right: 10px;
    border: 2px solid black;
  }

  .guildIcon\&Info {
    display: flex;
    align-items: center;
    font-size: 14px;
    font-weight: 600;
    color: white;
    font-family: Open Sans, sans-serif;
  }

  .menu {
    list-style: none;
    display: flex;
    align-items: center;
    -webkit-box-align: center;
    -webkit-box-pack: center;
    justify-content: center;
    -webkit-box-orient: horizontal;
    flex-direction: row;
    flex-wrap: wrap;
    color: white;
  }

  .menu > li {
    border: 10px solid #2b2f33;
    padding: 20px;
    transition: 800ms ease all;
  }

  .menu > li:hover {
    cursor: pointer;
    outline: none;
    border-bottom-color: rgb(23, 184, 238);
  }

  .config {
    text-align: center;
  }
</style>
